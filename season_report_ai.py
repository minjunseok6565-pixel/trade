from __future__ import annotations

import json
from datetime import date
from typing import Any, Dict

import google.generativeai as genai

from state import GAME_STATE, ensure_league_block
from stats_util import compute_league_leaders
from team_utils import get_conference_standings, get_team_detail
from config import ALL_TEAM_IDS

# news_ai.py ì— ìˆëŠ” ì‘ë‹µ í…ìŠ¤íŠ¸ ì¶”ì¶œ ìœ í‹¸ì„ ì¬ì‚¬ìš©í•œë‹¤.
from news_ai import _extract_text_from_gemini_response


SEASON_REPORT_TEMPLATE = """
### 1. í—¤ë” & ì¸íŠ¸ë¡œ

ğŸ“… ì •ê·œ ì‹œì¦Œ ì¢…ë£Œ â€“ {{SEASON_YEAR}} ì‹œì¦Œ ê²°ì‚°

{{SEASON_YEAR}} ì‹œì¦Œ ì •ê·œ ì‹œì¦Œì´ ë§‰ì„ ë‚´ë ¸ìŠµë‹ˆë‹¤.
{{TEAM_NAME}}ëŠ” **{{TEAM_RECORD_W}}ìŠ¹ {{TEAM_RECORD_L}}íŒ¨**ì˜ ì„±ì ìœ¼ë¡œ ì‹œì¦Œì„ ë§ˆê°í–ˆìŠµë‹ˆë‹¤.

[[GEN: ìœ„ ì„±ì ê³¼ ìˆœìœ„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë²ˆ ì‹œì¦Œ ì „ì²´ì— ëŒ€í•œ ì²«ì¸ìƒì„ 1ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ë¼.
      ì‹œì¦Œì´ ê¸°ëŒ€ ì´ìƒì´ì—ˆëŠ”ì§€, ì•„ì‰¬ì› ëŠ”ì§€, íŒŒë€ì„ ì¼ìœ¼ì¼°ëŠ”ì§€ ë“±ì„ ê°ê´€ì ì¸ ì§€í‘œë¥¼ ê·¼ê±°ë¡œ
      ì°¨ë¶„í•œ í•´ì„¤ì ì–´ì¡°ë¡œ í‘œí˜„í•˜ë¼.]]

# -------------------------------------------------
# CASE A. í”Œë ˆì´ì˜¤í”„ ì§í–‰ (1~6ìœ„)
# ì¡°ê±´: íŒ€ì´ í•´ë‹¹ ì½˜í¼ëŸ°ìŠ¤ì—ì„œ 1~6ìœ„ë¡œ ì‹œì¦Œì„ ë§ˆì³¤ì„ ë•Œ ì‚¬ìš©
# -------------------------------------------------
{{TEAM_NAME}}ëŠ” {{CONFERENCE_NAME}} ì½˜í¼ëŸ°ìŠ¤ì—ì„œ **{{TEAM_SEED}}ë²ˆ ì‹œë“œ**ë¥¼ í™•ë³´í•˜ë©°
í”Œë ˆì´ì˜¤í”„ì— ì§í–‰í–ˆìŠµë‹ˆë‹¤.

[[GEN: ì •ê·œ ì‹œì¦Œ ë™ì•ˆ íŒ€ì´ ì–´ë–¤ ê°•ì ì„ ë°”íƒ•ìœ¼ë¡œ í”Œë ˆì´ì˜¤í”„ ì§í–‰ì— ì„±ê³µí–ˆëŠ”ì§€
      1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•˜ë¼. ê³µê²©ë ¥, ìˆ˜ë¹„ë ¥, ë²¤ì¹˜ ëìŠ¤, íŠ¹ì • êµ¬ê°„ì˜ ì—°ìŠ¹ ë“±
      ì‹¤ì œ í†µê³„ì™€ ê²½ê¸°ë ¥ ë°ì´í„°ë¥¼ ê²°í•©í•´ ì„œìˆ í•˜ë˜, ê³¼ì¥ëœ í‘œí˜„ì€ í”¼í•˜ë¼.]]

# -------------------------------------------------
# CASE B. í”Œë ˆì´-ì¸ ì§„ì¶œ (7~8ìœ„)
# ì¡°ê±´: íŒ€ì´ 7ìœ„ ë˜ëŠ” 8ìœ„ë¡œ ì‹œì¦Œì„ ë§ˆì³¤ì„ ë•Œ ì‚¬ìš©
# -------------------------------------------------
{{TEAM_NAME}}ëŠ” {{CONFERENCE_NAME}} ì½˜í¼ëŸ°ìŠ¤ì—ì„œ **{{TEAM_SEED}}ë²ˆ ì‹œë“œ**ë¥¼ ê¸°ë¡í•˜ë©°
í”Œë ˆì´-ì¸ í† ë„ˆë¨¼íŠ¸ì— ë‚˜ì„œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì •ê·œ ì‹œì¦Œì„ í†µí•œ í”Œë ˆì´ì˜¤í”„ ì§í–‰ í‹°ì¼“ì€ ë†“ì³¤ì§€ë§Œ,
ì•„ì§ í”Œë ˆì´ì˜¤í”„ì— ì˜¬ë¼ê°ˆ ìˆ˜ ìˆëŠ” ê¸°íšŒëŠ” ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.

{{TEAM_NAME}}ëŠ” ë¨¼ì € **{{PLAYIN_MAIN_MATCH_LABEL}}** ë§ëŒ€ê²°ì—ì„œ
í”Œë ˆì´ì˜¤í”„ í‹°ì¼“ì— ë„ì „í•©ë‹ˆë‹¤.

í”Œë ˆì´ì˜¤í”„ ì§„ì¶œ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
- â‘  ì´ ê²½ê¸°ì—ì„œ ìŠ¹ë¦¬í•˜ë©´ ê³§ë°”ë¡œ í”Œë ˆì´ì˜¤í”„ì— ì§„ì¶œí•˜ì—¬ **{{PLAYOFF_SEED_IF_WIN_MAIN}}ë²ˆ ì‹œë“œ**ë¥¼ í™•ë³´í•©ë‹ˆë‹¤.
- â‘¡ ì´ ê²½ê¸°ì—ì„œ íŒ¨í•˜ë”ë¼ë„, **{{PLAYIN_LOWER_MATCH_LABEL}} ìŠ¹ìì™€ì˜ ìµœì¢…ì „**ì—ì„œ ìŠ¹ë¦¬í•˜ë©´
     **{{PLAYOFF_SEED_IF_WIN_LOWER}}ë²ˆ ì‹œë“œ**ë¡œ í”Œë ˆì´ì˜¤í”„ì— í•©ë¥˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[[GEN: ì§í–‰ì—ëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ ìƒìœ„ ì‹œë“œë¡œì„œ ì•„ì§ ì—¬ìœ ê°€ ë‚¨ì•„ ìˆë‹¤ëŠ” ì ê³¼,
      ë‹¨íŒ ìŠ¹ë¶€ì˜ ê¸´ì¥ê°ì´ ê³µì¡´í•œë‹¤ëŠ” ëŠë‚Œì„ 1~2ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•˜ë¼.
      íŒ€ì˜ ìµœê·¼ ê²½ê¸°ë ¥ì´ë‚˜ í•µì‹¬ ì„ ìˆ˜ ì»¨ë””ì…˜ì„ ê·¼ê±°ë¡œ,
      ì§€ë‚˜ì¹˜ê²Œ ë‚™ê´€ì /ë¹„ê´€ì ì´ì§€ ì•Šê²Œ ê· í˜• ì¡íŒ ì „ë§ì„ ì œì‹œí•˜ë¼.]]

# -------------------------------------------------
# CASE C. í”Œë ˆì´-ì¸ ì§„ì¶œ (9~10ìœ„)
# ì¡°ê±´: íŒ€ì´ 9ìœ„ ë˜ëŠ” 10ìœ„ë¡œ ì‹œì¦Œì„ ë§ˆì³¤ì„ ë•Œ ì‚¬ìš©
# -------------------------------------------------
{{TEAM_NAME}}ëŠ” {{CONFERENCE_NAME}} ì½˜í¼ëŸ°ìŠ¤ì—ì„œ **{{TEAM_SEED}}ë²ˆ ì‹œë“œ**ë¡œ
í”Œë ˆì´-ì¸ í† ë„ˆë¨¼íŠ¸ ë§‰ì°¨ë¥¼ íƒ”ìŠµë‹ˆë‹¤.
í”Œë ˆì´ì˜¤í”„ê¹Œì§€ëŠ” ì•„ì§ ê±°ë¦¬ê°€ ìˆì§€ë§Œ,
ë‹¨íŒ ìŠ¹ë¶€ì—ì„œ ì—°ìŠ¹ì„ ê±°ë‘”ë‹¤ë©´ ê·¹ì ì¸ ì§„ì¶œë„ ë…¸ë ¤ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{{TEAM_NAME}}ê°€ í”Œë ˆì´ì˜¤í”„ì— ì˜¤ë¥´ê¸° ìœ„í•´ì„œëŠ” **ë‘ ë²ˆì˜ ìŠ¹ë¦¬**ê°€ í•„ìš”í•©ë‹ˆë‹¤.
í”Œë ˆì´ì˜¤í”„ ì§„ì¶œ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
- â‘  ë¨¼ì € **{{PLAYIN_LOWER_MATCH_LABEL}}** ë‹¨íŒ ìŠ¹ë¶€ì—ì„œ ìŠ¹ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
- â‘¡ ì´ì–´ì„œ, **{{PLAYIN_MAIN_MATCH_LABEL}} íŒ¨ìì™€ ì¹˜ë¥´ëŠ” ìµœì¢…ì „**ì—ì„œë„ ìŠ¹ë¦¬í•˜ë©´
     í”Œë ˆì´ì˜¤í”„ ë§‰ì°¨ í‹°ì¼“ì„ ê±°ë¨¸ì¥˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[[GEN: ë‚®ì€ ì‹œë“œì—ì„œ ì¶œë°œí•˜ëŠ” ì–¸ë”ë… íŒ€ì´ë¼ëŠ” ì ì„ ë°”íƒ•ìœ¼ë¡œ,
      ìœ„í—˜ ë¶€ë‹´ê³¼ í•¨ê»˜ ì´ë³€ì„ ì¼ìœ¼í‚¬ ì—¬ì§€ë„ ìˆë‹¤ëŠ” ë¶„ìœ„ê¸°ë¥¼ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•˜ë¼.
      ì Šì€ ì„ ìˆ˜ë“¤ì˜ ì—ë„ˆì§€ë‚˜ ì—ì´ìŠ¤ì˜ ë‹¨íŒ ìŠ¹ë¶€ ì ì„±ì„ ê·¼ê±°ë¡œ ì‚¼ë˜,
      ê²°ê³¼ë¥¼ ë‹¨ì •í•˜ì§€ ë§ê³  ê°€ëŠ¥ì„±ì— ì´ˆì ì„ ë§ì¶”ì–´ í‘œí˜„í•˜ë¼.]]

# -------------------------------------------------
# CASE D. í”Œë ˆì´-ì¸ í† ë„ˆë¨¼íŠ¸ íƒˆë½
# ì¡°ê±´: í”Œë ˆì´-ì¸ í† ë„ˆë¨¼íŠ¸ê¹Œì§€ ì¹˜ë¥¸ ë’¤ íƒˆë½ì´ í™•ì •ëœ ê²½ìš° ì‚¬ìš©
# -------------------------------------------------
{{TEAM_NAME}}ëŠ” í”Œë ˆì´-ì¸ í† ë„ˆë¨¼íŠ¸ì—ì„œ íƒˆë½í•˜ë©°,
ì•„ì‰½ê²Œë„ ì´ë²ˆ ì‹œì¦Œ í”Œë ˆì´ì˜¤í”„ ì§„ì¶œì—ëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

[[GEN: í”Œë ˆì´-ì¸ê¹Œì§€ ë„ì „í–ˆë‹¤ëŠ” ì ì€ ê¸ì •ì ìœ¼ë¡œ í‰ê°€í•˜ë˜,
      ë§ˆì§€ë§‰ í•œ ê²½ê¸° í˜¹ì€ í•œ ê³ ë¹„ë¥¼ ë„˜ì§€ ëª»í•œ ì•„ì‰¬ì›€ì„ 1ë¬¸ì¥ ì •ë„ë¡œ ì •ë¦¬í•˜ë¼.
      ì´ ê²½í—˜ì´ ë‹¤ìŒ ì‹œì¦Œì— ì–´ë–¤ êµí›ˆì´ë‚˜ ê³¼ì œê°€ ë  ìˆ˜ ìˆì„ì§€ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì„œ ì–¸ê¸‰í•˜ë¼.]]

# -------------------------------------------------
# CASE E. í¬ìŠ¤íŠ¸ì‹œì¦Œ ì§„ì¶œ ì‹¤íŒ¨ (ì„ íƒ ì‚¬í•­)
# ì¡°ê±´: í”Œë ˆì´ì˜¤í”„/í”Œë ˆì´-ì¸ ëª¨ë‘ ì§„ì¶œí•˜ì§€ ëª»í•œ ê²½ìš° ì‚¬ìš©
# -------------------------------------------------
{{TEAM_NAME}}ëŠ” {{CONFERENCE_NAME}} ì½˜í¼ëŸ°ìŠ¤ì—ì„œ **{{TEAM_SEED}}ìœ„**ë¡œ ì‹œì¦Œì„ ë§ˆì¹˜ë©°,
í¬ìŠ¤íŠ¸ì‹œì¦Œ ì§„ì¶œì—ëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

[[GEN: íŒ€ì´ í¬ìŠ¤íŠ¸ì‹œì¦Œì— ì˜¤ë¥´ì§€ ëª»í•œ ë°°ê²½(ì „ë ¥ ì°¨ì´, ì¦ì€ ë¶€ìƒ, ì¬ê±´ ë‹¨ê³„ ë“±)ì„
      ì‹œì¦Œ ê¸°ë¡ê³¼ ìƒí™©ì„ ê·¼ê±°ë¡œ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•˜ë¼.
      íŠ¹ì • ê°œì¸ì„ ê³¼í•˜ê²Œ ë¹„íŒí•˜ê¸°ë³´ë‹¤ëŠ” íŒ€ ìˆ˜ì¤€ì˜ ê³¼ì œë¡œ ì •ë¦¬í•˜ê³ ,
      ë‹¤ìŒ ì‹œì¦Œì„ í–¥í•œ í•„ìš” ë³´ê°•ì´ë‚˜ ì„±ì¥ í¬ì¸íŠ¸ë¥¼ ê°„ë‹¨íˆ ì–¸ê¸‰í•˜ë¼.]]



### 2. {{TEAM_NAME}} ì‹œì¦Œ ìš”ì•½

- ìµœì¢… ì„±ì : **{{TEAM_RECORD_W}}ìŠ¹ {{TEAM_RECORD_L}}íŒ¨** (ìŠ¹ë¥  {{TEAM_WIN_PCT}})
- ì½˜í¼ëŸ°ìŠ¤ ìˆœìœ„: **{{CONF_RANK}}ìœ„ / {{CONF_TEAM_COUNT}}íŒ€**
- ë””ë¹„ì „: {{DIV_NAME}} ë””ë¹„ì „ **{{DIV_RANK}}ìœ„**
- íŒ€ í‰ê·  ë“ì : {{TEAM_PTS_PER_GAME}}ì  (ë¦¬ê·¸ {{TEAM_PTS_RANK}}ìœ„)
- íŒ€ í‰ê·  ì‹¤ì : {{TEAM_PTS_ALLOWED_PER_GAME}}ì  (ë¦¬ê·¸ {{TEAM_PTS_ALLOWED_RANK}}ìœ„)

ì£¼ìš” ì„ ìˆ˜ ì§€í‘œ:
- {{STAR_PLAYER_NAME}}: {{STAR_PTS}}ì  / {{STAR_REB}}ë¦¬ë°”ìš´ë“œ / {{STAR_AST}}ì–´ì‹œìŠ¤íŠ¸
- {{SECOND_PLAYER_NAME}}: {{SECOND_PTS}}ì  / {{SECOND_REB}}ë¦¬ë°”ìš´ë“œ / {{SECOND_AST}}ì–´ì‹œìŠ¤íŠ¸
- {{THIRD_PLAYER_NAME}} (ì„ íƒ): {{THIRD_PTS}}ì  / {{THIRD_REB}}ë¦¬ë°”ìš´ë“œ / {{THIRD_AST}}ì–´ì‹œìŠ¤íŠ¸

[[GEN: ìœ„ì— ì œì‹œëœ íŒ€/ì£¼ìš” ì„ ìˆ˜ ì§€í‘œì™€ ì‹œì¦Œ ì „ì²´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ
      {{TEAM_NAME}}ì˜ ì‹œì¦Œì„ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ë¼.
      ì‹œì¦Œ ì´ˆë°˜/ì¤‘ë°˜/í›„ë°˜ íë¦„, ê¸°ëŒ€ ëŒ€ë¹„ ì„±ê³¼(ì´ˆê³¼ ë‹¬ì„±/ë¯¸ë‹¬), ê³µê²©ê³¼ ìˆ˜ë¹„ ì¤‘ ì–´ëŠ ìª½ì´ ê°•ì ì´ì—ˆëŠ”ì§€ë¥¼
      ê°ê´€ì ì¸ ìˆ˜ì¹˜ì™€ í•¨ê»˜ í•´ì„¤ì í†¤ìœ¼ë¡œ ì •ë¦¬í•˜ë¼.]]



### 3. ë¦¬ê·¸ ì „ì²´ ì£¼ìš” ìŠ¤í† ë¦¬ë¼ì¸

- ìµœë‹¤ ìŠ¹ íŒ€: **{{BEST_TEAM_NAME}} ({{BEST_TEAM_RECORD_W}}ìŠ¹ {{BEST_TEAM_RECORD_L}}íŒ¨)**
- ìµœë‹¤ íŒ¨ íŒ€: **{{WORST_TEAM_NAME}} ({{WORST_TEAM_RECORD_W}}ìŠ¹ {{WORST_TEAM_RECORD_L}}íŒ¨)**

[[GEN: ì •ê·œ ì‹œì¦Œ ì „ì²´ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ,
      ë¦¬ê·¸ ì°¨ì›ì—ì„œ ê°€ì¥ í¬ê²Œ í™”ì œê°€ ë˜ì—ˆì„ ë§Œí•œ íŒ€ 2~3ê°œë¥¼ ì„ ì •í•˜ë¼.
      ëŒí’ì„ ì¼ìœ¼í‚¨ íŒ€, ê¸°ëŒ€ ëŒ€ë¹„ ë¶€ì§„í•œ íŒ€, ì¤‘ìœ„ê¶Œì—ì„œ ìƒìœ„ê¶Œìœ¼ë¡œ ë„ì•½í•œ íŒ€ ë“±ì„ ì¤‘ì‹¬ìœ¼ë¡œ,
      ê° íŒ€ì´ ì™œ ì£¼ëª©ë°›ì•˜ëŠ”ì§€ 3~4ë¬¸ì¥ ì´ë‚´ì˜ í•˜ë‚˜ì˜ ë¬¸ë‹¨ìœ¼ë¡œ ì •ë¦¬í•˜ë¼.
      ìˆœìœ„ ë³€í™”, ìŠ¹ë¥ , ì—°ìŠ¹/ì—°íŒ¨ ê¸°ë¡ ë“± ìˆ˜ì¹˜ë¥¼ ê·¼ê±°ë¡œ ì‚¼ë˜, ê³¼ë„í•œ ë¯¸ì‚¬ì—¬êµ¬ëŠ” í”¼í•˜ë¼.]]

[[GEN: ì •ê·œ ì‹œì¦Œ MVP ë ˆì´ìŠ¤ ìƒìœ„ê¶Œì— ìˆì„ ë§Œí•œ ì„ ìˆ˜ 2~3ëª…ì„ ê³¨ë¼,
      ê° ì„ ìˆ˜ê°€ íŒ€ ì„±ì ê³¼ ê°œì¸ ì„±ì ì—ì„œ ì–´ë–¤ ì„íŒ©íŠ¸ë¥¼ ë‚¨ê²¼ëŠ”ì§€ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ë¼.
      MVPê°€ ëˆ„êµ¬ì¸ì§€ ë‹¨ì •í•˜ì§€ ë§ê³ , ì—¬ëŸ¬ í›„ë³´ê°€ ê²½ìŸ ì¤‘ì´ë¼ëŠ” ë¶„ìœ„ê¸°ë¥¼ ìœ ì§€í•˜ë¼.]]



### 4. ê°œì¸ ìˆ˜ìƒ & ë¦¬ê·¸ ë¦¬ë” ë³´ë“œ

ë“ì , ë¦¬ë°”ìš´ë“œ, ì–´ì‹œìŠ¤íŠ¸ ë“± ì£¼ìš” ì§€í‘œ 1ìœ„ ì„ ìˆ˜:

- ë“ì ì™•: **{{SCORING_LEADER_NAME}} â€“ ê²½ê¸°ë‹¹ {{SCORING_LEADER_PPG}}ì **
- ë¦¬ë°”ìš´ë“œì™•: **{{REBOUND_LEADER_NAME}} â€“ ê²½ê¸°ë‹¹ {{REBOUND_LEADER_RPG}}ê°œ**
- ì–´ì‹œìŠ¤íŠ¸ì™•: **{{ASSIST_LEADER_NAME}} â€“ ê²½ê¸°ë‹¹ {{ASSIST_LEADER_APG}}ê°œ**
- ìŠ¤í‹¸ì™•: **{{STEAL_LEADER_NAME}} â€“ ê²½ê¸°ë‹¹ {{STEAL_LEADER_SPG}}ê°œ**
- ë¸”ë¡ì™•: **{{BLOCK_LEADER_NAME}} â€“ ê²½ê¸°ë‹¹ {{BLOCK_LEADER_BPG}}ê°œ**

[[GEN: ìœ„ ë¦¬ë” ë³´ë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ,
      ì´ë²ˆ ì‹œì¦Œ ê°œì¸ í¼í¬ë¨¼ìŠ¤ ì¤‘ íŠ¹íˆ ì—­ì‚¬ì ì´ê±°ë‚˜ ëˆˆì— ë„ëŠ” ê¸°ë¡ì´ ìˆë‹¤ë©´ 2ë¬¸ì¥ ì´ë‚´ë¡œ ì†Œê°œí•˜ë¼.
      í‰ê·  ë“ì , íŠ¸ë¦¬í”Œë”ë¸” ë¹ˆë„, ìˆ˜ë¹„ ìŠ¤íƒ¯ ë“± êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ í•¨ê»˜,
      í•´ë‹¹ ì„ ìˆ˜ê°€ íŒ€ ì„±ì ì— ë¼ì¹œ ì˜í–¥ì„ ê°„ë‹¨íˆ ì–¸ê¸‰í•˜ë¼.]]

[[GEN: ì‚¬ìš©ì íŒ€ ì†Œì† ì„ ìˆ˜ê°€ ìˆ˜ìƒì ë˜ëŠ” ì£¼ìš” í›„ë³´ë¡œ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´,
      ê·¸ ì„ ìˆ˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ 1~2ë¬¸ì¥ì„ ì¶”ê°€í•´ íŒ€ ë‚´ì—ì„œ ì–´ë–¤ ì—­í• ì„ í–ˆëŠ”ì§€ ì„¤ëª…í•˜ë¼.
      íŒ€ ì„±ì ê³¼ ê²°í•©í•´ ì‹œë„ˆì§€ë¥¼ ë³´ì˜€ëŠ”ì§€, í˜¹ì€ íŒ€ ì„±ì ê³¼ëŠ” ë³„ê°œë¡œ ê°œì¸ì ìœ¼ë¡œ ë¹›ë‚¬ëŠ”ì§€ë¥¼ ë¶„ì„ì ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë¼.]]



### 5. ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ë“¤

[[GEN: ì‹œì¦Œ ì „ì²´ ê²½ê¸° ë¡œê·¸ì™€ ë°•ìŠ¤ ìŠ¤ì½”ì–´ ë°ì´í„°ë¥¼ ê²€í† í•˜ì—¬,
      ì‚¬ìš©ì íŒ€ ê²½ê¸° ì¤‘ ì˜ë¯¸ ìˆëŠ” ì¥ë©´ 2~3ê°œë¥¼ ì„ íƒí•˜ë¼.
      ê° ì¥ë©´ë§ˆë‹¤ ë‹¤ìŒ ìš”ì†Œë¥¼ í¬í•¨í•´ 2~3ë¬¸ì¥ìœ¼ë¡œ í•˜ë‚˜ì˜ ë¬¸ë‹¨ì„ ì‘ì„±í•˜ë¼.
      - ì–¸ì œ(ë‚ ì§œ) ì–´ë–¤ ìƒëŒ€ì™€ì˜ ê²½ê¸°ì˜€ëŠ”ì§€
      - ì–´ë–¤ ì„ ìˆ˜ê°€ ì–´ë–¤ ê¸°ë¡ì´ë‚˜ ê²°ì •ì ì¸ í”Œë ˆì´ë¥¼ í–ˆëŠ”ì§€
      - ê·¸ ê²½ê¸°ê°€ ì‹œì¦Œ íë¦„ì— ì–´ë–¤ ì˜í–¥ì„ ë¯¸ì³¤ëŠ”ì§€
      ì´ 2~3ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ì •ë¦¬í•˜ë˜, ê³¼í•œ ë“œë¼ë§ˆ ì—°ì¶œë³´ë‹¤ëŠ” ì‹¤ì œ ë°ì´í„°ì— ë§ì¶˜ ì„œìˆ ì„ ìœ ì§€í•˜ë¼.]]


### 6. íŒ€ë³„ í•œ ì¤„ í‰ (ì˜µì…˜)

[[GEN: ë¦¬ê·¸ ì „ì²´ íŒ€ ì¤‘ì—ì„œ
      - ìƒìœ„ê¶Œ íŒ€ 2íŒ€(ì •ê·œ ì‹œì¦Œ ìŠ¹ë¥  ìƒìœ„ê¶Œ),
      - ì¤‘ìœ„ê¶Œ íŒ€ 1íŒ€,
      - í•˜ìœ„ê¶Œ íŒ€ 1íŒ€,
      - ê·¸ë¦¬ê³  ì‚¬ìš©ì íŒ€ {{TEAM_NAME}}
      ì— ëŒ€í•´ íŒ€ë³„ í•œ ì¤„ í‰ì„ ì‘ì„±í•˜ë¼.
      ê° ì¤„ì€ â€œíŒ€ ì´ë¦„: ì„¤ëª…â€ í˜•ì‹(íŒ€ ì´ë¦„, ì½œë¡ , ì‹œì¦Œ ìš”ì•½ í•œ ë¬¸ì¥)ìœ¼ë¡œ ì‘ì„±í•˜ë˜,
      ì„¤ëª… ë¬¸ì¥ì€ íŒ€ì˜ ìˆœìœ„, ìŠ¹ë¥ , í”Œë ˆì´ì˜¤í”„/í”Œë ˆì´-ì¸ ì§„ì¶œ ì—¬ë¶€ë¥¼ ê·¼ê±°ë¡œ
      ì§§ê³  ëª…ë£Œí•˜ê²Œ ìš”ì•½í•˜ë¼.
      ìœ ë¨¸ë‚˜ ë¹„ìœ ëŠ” ê°€ë³ê²Œë§Œ ì‚¬ìš©í•˜ê³ , ëª¨ìš•ì ì´ê±°ë‚˜ ê³¼í•œ í‘œí˜„ì€ í”¼í•˜ë¼.]]



### 7. ë‹¤ìŒ ë‹¨ê³„ ì „ë§

# ---- P1. ì•„ì§ í¬ìŠ¤íŠ¸ì‹œì¦Œì´ ë‚¨ì•„ ìˆëŠ” ê²½ìš°
# (í”Œë ˆì´ì˜¤í”„ ì§í–‰ ë˜ëŠ” í”Œë ˆì´-ì¸ ì§„ì¶œ ìƒíƒœì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡)
[[GEN: íŒ€ì´ ì•„ì§ í¬ìŠ¤íŠ¸ì‹œì¦Œì— ë‚¨ì•„ ìˆëŠ” ìƒí™©ì„ ì „ì œë¡œ,
      1~2ë¬¸ë‹¨ ë¶„ëŸ‰ìœ¼ë¡œ ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•´ ì‘ì„±í•˜ë¼.
      - í”Œë ˆì´ì˜¤í”„ ì§í–‰ íŒ€ì¸ ê²½ìš°: 1ë¼ìš´ë“œ ì˜ˆìƒ ëŒ€ì§„(ìƒëŒ€ íŒ€ ì´ë¦„, ì‹œë“œ, ì •ê·œ ì‹œì¦Œ ìƒëŒ€ ì „ì  ë“±)ì„ ìš”ì•½í•˜ê³ ,
        ì–‘ íŒ€ì˜ ì—ì´ìŠ¤ ë§¤ì¹˜ì—…ê³¼ ì‹œë¦¬ì¦ˆì˜ í•µì‹¬ í¬ì¸íŠ¸ë¥¼ í•´ì„¤ì ì–´ì¡°ë¡œ ì„¤ëª…í•˜ë¼.
      - í”Œë ˆì´-ì¸ íŒ€ì¸ ê²½ìš°: í”Œë ˆì´-ì¸ ë¸Œë˜í‚· êµ¬ì¡°(ì²« ê²½ê¸° ìƒëŒ€, ì´í›„ ë§Œë‚  ìˆ˜ ìˆëŠ” ìƒëŒ€)ë¥¼ ì •ë¦¬í•˜ê³ ,
        ë‹¨íŒ ìŠ¹ë¶€ì—ì„œ ì¤‘ìš”í•  ìš”ì†Œ(ë²¤ì¹˜ ëìŠ¤, ìŠ¤íƒ€ íŒŒì›Œ, ìµœê·¼ í¼ ë“±)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì „ë§ì„ ì œì‹œí•˜ë¼.
      ìŠ¹íŒ¨ë¥¼ ë‹¨ì •í•˜ì§€ ë§ê³ , ì–´ë–¤ ìš”ì†Œê°€ ìŠ¹ë¶€ë¥¼ ê°€ë¥¼ ìˆ˜ ìˆì„ì§€ì— ì´ˆì ì„ ë§ì¶”ì–´ ê¸°ìˆ í•˜ë¼.]]

# ---- P2. ì‹œì¦Œì´ ì´ë¯¸ ì¢…ë£Œëœ ê²½ìš°
# (í”Œë ˆì´-ì¸ íƒˆë½ ë˜ëŠ” í¬ìŠ¤íŠ¸ì‹œì¦Œ ì§„ì¶œ ì‹¤íŒ¨ ìƒíƒœì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¸”ë¡)
[[GEN: íŒ€ì˜ ì‹œì¦Œì´ ì´ë¯¸ ì¢…ë£Œëœ ìƒí™©ì„ ì „ì œë¡œ,
      1~2ë¬¸ë‹¨ ë¶„ëŸ‰ìœ¼ë¡œ ì˜¤í”„ì‹œì¦Œ ì „ë§ì„ ì‘ì„±í•˜ë¼.
      ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•˜ë˜, ì‹¤ì œ ë°ì´í„° ë²”ìœ„ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ë¼.
      - ì´ë²ˆ ì‹œì¦Œì—ì„œ ì–»ì€ ìˆ˜í™•(ì Šì€ ì„ ìˆ˜ ì„±ì¥, íŠ¹ì • ì „ìˆ ì˜ ê°€ëŠ¥ì„±, ì¤‘ë°˜ ì´í›„ ë°˜ë“± ë“±)
      - ì˜¤í”„ì‹œì¦Œ í•µì‹¬ ê³¼ì œ(ë³´ê°•ì´ í•„ìš”í•œ í¬ì§€ì…˜, ìˆ˜ë¹„/ê³µê²© ìª½ ê°œì„  í•„ìš” ì˜ì—­ ë“±)
      - ë“œë˜í”„íŠ¸ ì§€ëª… ìˆœìœ„ ì˜ˆìƒ ë²”ìœ„ë‚˜ FA ì‹œì¥ì—ì„œ ë…¸ë¦´ ë§Œí•œ ì„ ìˆ˜ ìœ í˜•
      êµ¬ì²´ì ì¸ ê³„ì•½ ì¡°ê±´ì´ë‚˜ í™•ì •ë˜ì§€ ì•Šì€ ì´ì ì„ ë‹¨ì •í•˜ëŠ” í‘œí˜„ì€ í”¼í•˜ê³ ,
      ë°©í–¥ì„±ê³¼ ê³¼ì œ ì¤‘ì‹¬ìœ¼ë¡œ ì •ë¦¬í•˜ë¼.]]



### 8. ì—”ë”© ë©˜íŠ¸

[[GEN: ì‹œì¦Œ ì „ì²´ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ìƒê¸°ì‹œí‚¤ë©´ì„œ,
      {{TEAM_NAME}}ì˜ {{SEASON_YEAR}} ì‹œì¦Œì´ ì–´ë–¤ ì˜ë¯¸ë¥¼ ê°€ì¡ŒëŠ”ì§€
      2ë¬¸ì¥ ì´ë‚´ë¡œ ìš”ì•½í•˜ëŠ” ë§ˆë¬´ë¦¬ ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ë¼.
      ë°ì´í„° ê¸°ë°˜ í‰ê°€ì— ì•½ê°„ì˜ ê°ì •ì„ ë”í•´,
      í”Œë ˆì´ì–´ê°€ í•œ ì‹œì¦Œ ì‹œë®¬ë ˆì´ì…˜ì„ ë§ˆë¬´ë¦¬í–ˆë‹¤ëŠ” ëŠë‚Œì„ ì¤„ ìˆ˜ ìˆë„ë¡ í•˜ë¼.]]

ì´ë¡œì¨ {{SEASON_YEAR}} ì‹œì¦Œ ì •ê·œ ì‹œì¦Œ ì—¬ì •ì€ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ì œ {{TEAM_NAME}}ëŠ” ë‹¤ìŒ ë‹¨ê³„ë¥¼ í–¥í•´ ë‚˜ì•„ê°€ì•¼ í•©ë‹ˆë‹¤.

[[GEN: í”Œë ˆì´ì–´ê°€ ì´ í™”ë©´ ì´í›„ì— í•  ìˆ˜ ìˆëŠ” í–‰ë™(ì˜ˆ: í”Œë ˆì´ì˜¤í”„ ì‹œë®¬ë ˆì´ì…˜ ì§„í–‰, ì‹œì¦Œ í†µê³„ ìƒì„¸ í™•ì¸,
      ë¡œìŠ¤í„°/ì „ìˆ  ì¬ê²€í†  ë“±)ì„ ê°„ë‹¨íˆ ì•ˆë‚´í•˜ëŠ” í•œ ë¬¸ì¥ì„ ì‘ì„±í•˜ë¼.
      êµ¬ì²´ì ì¸ ë²„íŠ¼ ì´ë¦„ ëŒ€ì‹ , ì„ íƒ ê°€ëŠ¥í•œ ì•¡ì…˜ì˜ ì¢…ë¥˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì†Œê°œí•˜ëŠ” ìˆ˜ì¤€ìœ¼ë¡œ í‘œí˜„í•˜ë¼.]]
"""


def build_season_context(user_team_id: str) -> Dict[str, Any]:
    user_team_id = (user_team_id or "").upper()
    if user_team_id not in ALL_TEAM_IDS:
        raise ValueError(f"Unknown team id: {user_team_id}")

    league = ensure_league_block()
    current_date = league.get("current_date") or date.today().isoformat()

    standings = get_conference_standings()
    team_detail = get_team_detail(user_team_id)
    leaders = compute_league_leaders()

    conference_key = None
    conf_entry: Dict[str, Any] | None = None
    for conf, teams in standings.items():
        for t in teams:
            if t.get("team_id") == user_team_id:
                conference_key = conf
                conf_entry = dict(t)
                break
        if conf_entry:
            break

    conference_name = None
    conf_rank = None
    conference_team_count = None
    division_name = None
    division_rank = None
    postseason_status = None

    if conference_key:
        conference_name = "East" if conference_key.lower() == "east" else "West"
        conference_team_count = len(standings.get(conference_key, []))

    if conf_entry:
        conf_rank = conf_entry.get("rank")
        division_name = conf_entry.get("division")
        if division_name:
            division_rows = [t for t in standings.get(conference_key, []) if t.get("division") == division_name]
            for idx, row in enumerate(division_rows, start=1):
                if row.get("team_id") == user_team_id:
                    division_rank = idx
                    break

        if isinstance(conf_rank, int):
            if conf_rank <= 6:
                postseason_status = "playoffs"
            elif conf_rank <= 10:
                postseason_status = "play-in"
            else:
                postseason_status = "out"

    team_summary = team_detail.get("summary", {}) if isinstance(team_detail, dict) else {}
    team_context = {
        "team_id": user_team_id,
        "conference": conference_key,
        "conference_name": conference_name,
        "conference_rank": conf_rank,
        "conference_team_count": conference_team_count,
        "division": division_name,
        "division_rank": division_rank,
        "wins": team_summary.get("wins"),
        "losses": team_summary.get("losses"),
        "win_pct": team_summary.get("win_pct"),
        "point_diff": team_summary.get("point_diff"),
        "postseason_status": postseason_status,
    }

    ctx: Dict[str, Any] = {
        "current_date": current_date,
        "season_year": league.get("season_year") or date.today().year,
        "user_team_id": user_team_id,
        "standings": standings,
        "team_detail": team_detail,
        "team_context": team_context,
        "league_leaders": leaders,
        "all_games": GAME_STATE.get("games", []),
    }
    return ctx


def generate_season_report(api_key: str, user_team_id: str) -> str:
    """
    ì£¼ì–´ì§„ api_keyì™€ user_team_idë¥¼ ì´ìš©í•´ Geminië¥¼ í˜¸ì¶œí•˜ì—¬
    ì‹œì¦Œ ê²°ì‚° ë¦¬í¬íŠ¸(í•œêµ­ì–´ ë§ˆí¬ë‹¤ìš´)ë¥¼ ìƒì„±í•˜ê³ , ì™„ì„±ëœ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.
    """

    if not api_key:
        raise ValueError("apiKey is required")

    ctx = build_season_context(user_team_id)
    ctx_json = json.dumps(ctx, ensure_ascii=False)

    genai.configure(api_key=api_key)
    model = genai.GenerativeModel("gemini-3-pro-preview")

    prompt = f"""
ë‹¹ì‹ ì€ í•œêµ­ì–´ë¡œ í•´ì„¤í•˜ëŠ” ê°€ìƒì˜ NBA GM ì‹œë®¬ë ˆì´ì…˜ ê²Œì„ì˜ ê³µì‹ í•´ì„¤ìì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” ì´ ë¦¬ê·¸ì˜ ì‹œì¦Œ ë°ì´í„°(JSON)ì™€, ì‹œì¦Œ ê²°ì‚° ë¦¬í¬íŠ¸ í…œí”Œë¦¿ì…ë‹ˆë‹¤.
í…œí”Œë¦¿ì˜ ì œëª©ê³¼ ì„¹ì…˜ ìˆœì„œë¥¼ ìœ ì§€í•˜ë˜,
- {{...}} ë¡œ í‘œì‹œëœ ìë¦¬ëŠ” JSONì— ë“¤ì–´ ìˆëŠ” ì‹¤ì œ ìˆ˜ì¹˜ì™€ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì±„ì›Œ ë„£ìœ¼ì‹­ì‹œì˜¤.
- [[GEN: ...]] ë¡œ í‘œì‹œëœ ìë¦¬ëŠ” ì œê³µëœ ì‹œì¦Œ ë°ì´í„°ë¥¼ ì°¸ê³ í•´ ì•Œë§ì€ ë¬¸ì¥/ë¬¸ë‹¨ì„ ì‘ì„±í•˜ê³ , í‘œì‹œë¥¼ ì œê±°í•˜ì‹­ì‹œì˜¤.

 - ê²°ê³¼ëŠ” í•œêµ­ì–´ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
 - JSONì´ë‚˜ ë³„ë„ì˜ ì„¤ëª…ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 - ìˆ˜ì¹˜ëŠ” ê°€ëŠ¥í•œ í•œ ì»¨í…ìŠ¤íŠ¸ ë‚´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë˜, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ë§ê³  ê±´ë„ˆëœë‹ˆë‹¤.
 - ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ì°¨ë¶„í•œ í•´ì„¤ì í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤.

 [ì‹œì¦Œ ë°ì´í„° JSON]
 {ctx_json}

[ë¦¬í¬íŠ¸ í…œí”Œë¦¿]
{SEASON_REPORT_TEMPLATE}
"""

    resp = model.generate_content(prompt)
    text = _extract_text_from_gemini_response(resp)
    return text
